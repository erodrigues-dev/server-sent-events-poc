(()=>{"use strict";var t=function(e,s){if(!(this instanceof t))return new t(e,s);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,s=s||{},this.headers=s.headers||{},this.payload=void 0!==s.payload?s.payload:"",this.method=s.method||(this.payload?"POST":"GET"),this.withCredentials=!!s.withCredentials,this.debug=!!s.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(t,e){void 0===this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(e)&&this.listeners[t].push(e)},this.removeEventListener=function(t,e){if(void 0!==this.listeners[t]){var s=[];this.listeners[t].forEach((function(t){t!==e&&s.push(t)})),0===s.length?delete this.listeners[t]:this.listeners[t]=s}},this.dispatchEvent=function(t){if(!t)return!0;this.debug&&console.debug(t),t.source=this;var e="on"+t.type;return(!this.hasOwnProperty(e)||(this[e].call(this,t),!t.defaultPrevented))&&(!this.listeners[t.type]||this.listeners[t.type].every((function(e){return e(t),!t.defaultPrevented})))},this._setReadyState=function(t){var e=new CustomEvent("readystatechange");e.readyState=t,this.readyState=t,this.dispatchEvent(e)},this._onStreamFailure=function(t){var e=new CustomEvent("error");e.data=t.currentTarget.response,this.dispatchEvent(e),this.close()},this._onStreamAbort=function(t){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(t){if(this.xhr)if(200===this.xhr.status){this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var e=this.xhr.responseText.substring(this.progress);this.progress+=e.length;var s=(this.chunk+e).split(/(\r\n\r\n|\r\r|\n\n)/g),i=s.pop();s.forEach(function(t){t.trim().length>0&&this.dispatchEvent(this._parseEventChunk(t))}.bind(this)),this.chunk=i}else this._onStreamFailure(t)},this._onStreamLoaded=function(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(t){if(!t||0===t.length)return null;this.debug&&console.debug(t);var e={id:null,retry:null,data:null,event:null};t.split(/\n|\r\n|\r/).forEach(function(t){var s,i,n=t.indexOf(this.FIELD_SEPARATOR);if(n>0){var r=" "===t[n+1]?2:1;s=t.substring(0,n),i=t.substring(n+r)}else{if(!(n<0))return;s=t,i=""}s in e&&("data"===s&&null!==e[s]?e.data+="\n"+i:e[s]=i)}.bind(this));var s=new CustomEvent(e.event||"message");return s.data=e.data||"",s.id=e.id,s},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){for(var t in this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url),this.headers)this.xhr.setRequestHeader(t,this.headers[t]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(void 0===s.start||s.start)&&this.stream()};"undefined"!=typeof exports&&(exports.SSE=t);let e=null;const s=document.getElementById("btn-sse-start"),i=document.getElementById("btn-sse-close");s.onclick=function s(){console.log("SSE start"),e=new t("/api/events",{headers:{"x-origin-application":"poc-sse"}});const i=document.getElementById("sse-text");e.addEventListener("count",(t=>{console.log(t.data),i.innerText=`event: count - ${JSON.parse(t.data).count}`})),e.addEventListener("closed",(t=>{console.log("closed",t.data),i.innerText="event: closed",e.close()})),e.addEventListener("connected",(t=>{console.log(t.data),i.innerText="event: connected"})),e.addEventListener("error",(t=>{console.log("onError"),setTimeout((()=>{console.log("reconnecting...."),s()}),1e3)}))},i.onclick=function(){e.close(),h2.innerText="event source is closed"}})();